//v1.0.9  @author Alin   www.cgdev.net
import * as THREE from './THREE.js';
let JDLoader=function(u){this.manager=void 0!==u?u:THREE.DefaultLoadingManager};JDLoader.prototype={constructor:JDLoader,load:function(u,v,x,K){var I=this,L=this.texturePath&&"string"===typeof this.texturePath?this.texturePath:THREE.LoaderUtils.extractUrlBase(u);(new THREE.FileLoader(this.manager)).load(u,function(u){I.loadText(u,v,L)},x,K)},loadText:function(u,v,x){if(u=JSON.parse(u))x=this.parse(u,x),v(x)},setTexturePath:function(u){this.texturePath=u},parse:function(u,v){function x(d){for(var a=[],b=0;b<J.length;++b){var c=new THREE.MeshPhongMaterial({});c.copy(J[b]);d.morphTargets&&0<d.morphTargets.length&&(c.morphTargets=!0);a.push(c)}return a}function K(d,a){if(a.morphTargets&&0<a.morphTargets.length){console.log("initMorphTargetInfluence "+d.name);for(var b=[],c=0;c<a.morphTargets.length;++c)b.push(.01*a.morphTargets[c].influence);d.morphTargetInfluences=b}}function I(d){var a=new THREE.Matrix4;if(!y||0>d||!y[d])return a;for(;0<=d;d=y[d].parent){var b=y[d],c=new THREE.Vector3(b.pos[0],b.pos[1],b.pos[2]),e=new THREE.Vector3(b.scl[0],b.scl[1],b.scl[2]),b=new THREE.Quaternion(b.rotq[0],b.rotq[1],b.rotq[2],b.rotq[3]),c=(new THREE.Matrix4).compose(c,b,e);a.premultiply(c)}return a}function L(d,a){if(!d)return console.error("parseOffsetAnimation: no animation"),null;var b=d.fps||30,c=!0,e=d.length||-1;"frames"==d.timeline&&(c=!1,e/=b);var h=[],l=d.name||"default",m=(d.animNodes||[])[a];if(!m)return console.error("parseOffsetAnimation: animNode "+a+" is null !"),null;var g="";void 0!==m.nodeName?g=m.nodeName:void 0!==m.nodeIndex&&(g=y[m.nodeIndex].name);for(var m={times:[],values:[]},f={times:[],values:[]},k={times:[],values:[]},p=[],q=a;0<=q;q=y[q].parent)var t=d.animNodes[q],p=N(p,t.scl.times),p=N(p,t.rot.times),p=N(p,t.pos.times);m.times=m.times.concat(p);f.times=f.times.concat(p);k.times=k.times.concat(p);var q=new THREE.Vector3,t=new THREE.Vector3,u=new THREE.Quaternion,A;new THREE.Matrix4;for(var z=I(a).invert(),w=0;w<p.length;++w){A=d;var C=a,v=p[w],E=new THREE.Matrix4;if(y&&!(0>C)&&A.animNodes[C])for(var D,r,B,x,F,n;0<=C;C=y[C].parent)n=A.animNodes[C],D=M(n.scl.times,v),r=D.iBegin,B=D.iEnd,r==B?F=new THREE.Vector3(n.scl.values[3*r],n.scl.values[3*r+1],n.scl.values[3*r+2]):(D=(v-n.scl.times[r])/(n.scl.times[B]-n.scl.times[r]),F=new THREE.Vector3(n.scl.values[3*r],n.scl.values[3*r+1],n.scl.values[3*r+2]),x=new THREE.Vector3(n.scl.values[3*B],n.scl.values[3*B+1],n.scl.values[3*B+2]),F=F.lerp(x,D)),D=M(n.pos.times,v),r=D.iBegin,B=D.iEnd,r==B?x=new THREE.Vector3(n.pos.values[3*r],n.pos.values[3*r+1],n.pos.values[3*r+2]):(D=(v-n.pos.times[r])/(n.pos.times[B]-n.pos.times[r]),x=new THREE.Vector3(n.pos.values[3*r],n.pos.values[3*r+1],n.pos.values[3*r+2]),r=new THREE.Vector3(n.pos.values[3*B],n.pos.values[3*B+1],n.pos.values[3*B+2]),x=x.lerp(r,D)),D=M(n.rot.times,v),r=D.iBegin,B=D.iEnd,r==B?r=new THREE.Quaternion(n.rot.values[4*r],n.rot.values[4*r+1],n.rot.values[4*r+2],n.rot.values[4*r+3]):(D=(v-n.rot.times[r])/(n.rot.times[B]-n.rot.times[r]),r=new THREE.Quaternion(n.rot.values[4*r],n.rot.values[4*r+1],n.rot.values[4*r+2],n.rot.values[4*r+3]),n=new THREE.Quaternion(n.rot.values[4*B],n.rot.values[4*B+1],n.rot.values[4*B+2],n.rot.values[4*B+3]),r=r.slerp(n,D)),F=(new THREE.Matrix4).compose(x,r,F),E.premultiply(F);A=E;A.multiply(z);A.decompose(q,u,t);m.values.push(t.x);m.values.push(t.y);m.values.push(t.z);k.values.push(q.x);k.values.push(q.y);k.values.push(q.z);f.values.push(u.x);f.values.push(u.y);f.values.push(u.z);f.values.push(u.w)}G(c,b,THREE.VectorKeyframeTrack,g+".position",k,h);G(c,b,THREE.VectorKeyframeTrack,g+".scale",m,h);G(c,b,THREE.QuaternionKeyframeTrack,g+".quaternion",f,h);return 0===h.length?(console.error("parseOffsetAnimation: tracks.length is 0 !"),null):new THREE.AnimationClip(l,e,h)}function M(d,a){for(var b=0,c=0,e=0;e<d.length;++e)if(d[e]==a){b=c=e;break}else if(d[e]>a){b=c=e;break}else if(e==d.length-1){b=c=e;break}else if(a<d[e+1]){b=e;c=e+1;break}return{iBegin:b,iEnd:c}}function N(d,a){for(var b=[],c=0,e=0;c<d.length&&e<a.length;)d[c]<a[e]?(0!=b.length&&d[c]==b[b.length-1]||b.push(d[c]),++c):(d[c]>a[e]?0!=b.length&&a[e]==b[b.length-1]||b.push(a[e]):(0!=b.length&&b[b.length-1]==d[c]||b.push(d[c]),++c),++e);for(;c<d.length;)0!=b.length&&d[c]==b[b.length-1]||b.push(d[c]),++c;for(;e<a.length;)0!=b.length&&a[e]==b[b.length-1]||b.push(a[e]),++e;return b}function G(d,a,b,c,e,h){if(e&&Array.isArray(e.times)&&Array.isArray(e.values)){var l=[],m=[],l=l.concat(e.times),m=m.concat(e.values);if(!d)for(d=0;d<l.length;++d)l[d]/=a;l&&0!=l.length&&m&&0!=m.length&&h.push(new b(c,l,m))}}var E=0,H=this,J=[],y=[],t=[],O=[],P=[],Q=[],w=[];(function(){J=[];if(void 0!==u.materials&&0!==u.materials.length){var d,a,b,c,e,h,l,m,g,f;for(f=0;f<u.materials.length;++f){var k=u.materials[f];d=new THREE.Color(16777215);a=new THREE.Color(1644825);k.diffuse&&d.fromArray(k.diffuse);k.specular&&a.fromArray(k.specular);b=void 0!==k.glossiness?k.glossiness:40;g=m=l=h=e=c=void 0;if(k.maps)for(var p=0;p<k.maps.length;++p)if(""!=k.maps[p].file)if("diffuse"==k.maps[p].type){var q=new THREE.TextureLoader;q.setCrossOrigin(H.crossOrigin);c=q.load(v+k.maps[p].file);c.wrapS=c.wrapT=THREE.RepeatWrapping}else"specular"==k.maps[p].type?(q=new THREE.TextureLoader,q.setCrossOrigin(H.crossOrigin),e=q.load(v+k.maps[p].file),e.wrapS=e.wrapT=THREE.RepeatWrapping):"bump"==k.maps[p].type?(q=new THREE.TextureLoader,q.setCrossOrigin(H.crossOrigin),h=q.load(v+k.maps[p].file),h.wrapS=h.wrapT=THREE.RepeatWrapping):"normal"==k.maps[p].type?(q=new THREE.TextureLoader,q.setCrossOrigin(H.crossOrigin),l=q.load(v+k.maps[p].file),l.wrapS=l.wrapT=THREE.RepeatWrapping):"opacity"==k.maps[p].type?(q=new THREE.TextureLoader,q.setCrossOrigin(H.crossOrigin),m=q.load(v+k.maps[p].file),m.wrapS=m.wrapT=THREE.RepeatWrapping):"lightmap"==k.maps[p].type&&(q=new THREE.TextureLoader,q.setCrossOrigin(H.crossOrigin),g=q.load(v+k.maps[p].file),g.wrapS=g.wrapT=THREE.RepeatWrapping);d=new THREE.MeshPhongMaterial({name:name,color:d.getHex(),specular:a.getHex(),shininess:b,skinning:!0});c&&(d.map=c);e&&(d.specularMap=e);h&&(d.bumpMap=h);l&&(d.normalMap=l);m&&(d.alphaMap=m,d.transparent=!0);g&&(d.lightMap=g);void 0!==k.opacity&&(d.opacity=k.opacity,1>k.opacity&&(d.transparent=!0));J.push(d)}}})();(function(){y=void 0!==u.hierarchy?u.hierarchy.nodes:u.nodes;if(Array.isArray(y)&&0<y.length)for(var d=0;d<y.length;++d)void 0!==y[d].rot&&(y[d].rotq=y[d].rot,y[d].rot=void 0);else y=[]})();(function(){var d=u.model;if(d){var a,b,c,e,h,l,m,g,f,k,p,q,w,v,A,z,x;if(d.splineShapes)for(m=0;m<d.splineShapes.length;++m){q=d.splineShapes[m];if(void 0==q)break;k=q.node;p=I(k);for(x=0;x<q.splines.length;++x){h=new THREE.BufferGeometry;h.name=q.name;1<q.splines.length&&(h.name+="_SubSpline"+x);l=new THREE.CurvePath;g=q.splines[x];for(a=0;a+2<g.points.length;a+=3)c=new THREE.Vector3(g.points[a],g.points[a+1],g.points[a+2]),c.applyMatrix4(p),g.points[a]=c.x,g.points[a+1]=c.y,g.points[a+2]=c.z;for(a=0;a+11<g.points.length;a+=9)e=new THREE.CubicBezierCurve3(new THREE.Vector3(g.points[a],g.points[a+1],g.points[a+2]),new THREE.Vector3(g.points[a+3],g.points[a+4],g.points[a+5]),new THREE.Vector3(g.points[a+6],g.points[a+7],g.points[a+8]),new THREE.Vector3(g.points[a+9],g.points[a+10],g.points[a+11])),l.add(e);h.setFromPoints(l.getPoints(q.steps+1));t.push(h);P.push("Line");Q.push(q);O.push(k)}}if(d.meshes)for(x=0;x<d.meshes.length;++x){h=new THREE.BufferGeometry;m=d.meshes[x];if(void 0==m)break;m.name&&(h.name=m.name);e=m.verts;if(void 0==e)break;k=m.vertElement;if(void 0==k)break;p=m.face;q=k.vertIndices;w=k.normals;v=k.uvs;l=m.skin;k=m.node;if(void 0==k||!(0<=k&&k<y.length))break;g=y[k];if(!(g&&g.pos&&g.rotq&&g.scl))break;if(void 0==p)break;A=p.vertElementIndices;z=p.groups;if(!A||!z)break;p=I(k);g=q.length;var C=new Float32Array(3*g);for(f=0;f<g;++f)a=3*q[f],b=3*f,c=new THREE.Vector3(e[a],e[a+1],e[a+2]),c.applyMatrix4(p),C[b]=c.x,C[b+1]=c.y,C[b+2]=c.z;h.setAttribute("position",new THREE.BufferAttribute(C,3));if(void 0!==w&&0<w.length){c=(new THREE.Matrix3).getNormalMatrix(p);b=new Float32Array(w);for(a=0;a+2<w.length;a+=3)f=new THREE.Vector3(w[a],w[a+1],w[a+2]),f.applyMatrix3(c).normalize(),b[a]=f.x,b[a+1]=f.y,b[a+2]=f.z;h.setAttribute("normal",new THREE.BufferAttribute(b,3))}if(void 0!==v&&0<v.length){a:if(a=-1,z&&u.materials){for(f=0;f<z.length;++f)if((c=u.materials[z[f].materialIndex])&&c.maps)for(b=0;b<c.maps.length;++b)if("diffuse"==c.maps[b].type)if(0>a)a=c.maps[b].uvsIndex;else if(a!=c.maps[b].uvsIndex)break a;a=0>a?0:a}else a=0;a=a<v.length?a:0;f=new Float32Array(v[a]);h.setAttribute("uv",new THREE.BufferAttribute(f,2));if(1<v.length){a:{if(z&&u.materials)for(a=0;a<z.length;++a)if((f=u.materials[z[a].materialIndex])&&f.maps)for(c=0;c<f.maps.length;++c)if("lightmap"==f.maps[c].type){a=f.maps[c].uvsIndex;break a}a=-1}0<=a&&(f=new Float32Array(v[a]),h.setAttribute("uv2",new THREE.BufferAttribute(f,2)),console.log("lightmap uv index "+a))}}a=new Uint32Array(A);h.setIndex(new THREE.BufferAttribute(a,1));h.groups=z;e=e.length/3;v=[];A=[];if(l&&l.skinBones&&l.skinWeights&&l.skinBones.length==l.skinWeights.length)for(f=0;f<e;++f){z=new THREE.Vector4(0,0,0,0);a=new THREE.Vector4(0,0,0,0);for(c=b=0;4>c;++c)c<l.skinBones[f].length?(z.setComponent(c,l.skinBones[f][c]),a.setComponent(c,l.skinWeights[f][c]),++b):(z.setComponent(c,0),a.setComponent(c,0));for(;b<l.skinWeights[f].length;)a.addScalar(.25*l.skinWeights[f][b]),++b;v.push(z);A.push(a)}if(0<v.length&&0<A.length)for(l="SkinnedMesh",h.setAttribute("skinIndex",new THREE.Float32BufferAttribute(new Float32Array(4*g),4)),h.setAttribute("skinWeight",new THREE.Float32BufferAttribute(new Float32Array(4*g),4)),f=0;f<g;++f)a=q[f],z=v[a],a=A[a],h.attributes.skinIndex.setXYZW(f,z.x,z.y,z.z,z.w),h.attributes.skinWeight.setXYZW(f,a.x,a.y,a.z,a.w);else l="Mesh";g=Number(THREE.REVISION.replace(/[^0-9]/ig,""));"SkinnedMesh"!=l||98<g||(g=getBones(m))&&0<g.length&&(h.bones=g);if(m.morphTargets&&m.morphTargets.length){console.log("gen morph targets");v=m.morphTargets;e=v.length;w=[];for(z=0;z<e;++z){A=v[z];g=q.length;C=new Float32Array(3*g);for(f=0;f<g;++f)a=3*q[f],b=3*f,c=new THREE.Vector3(A.verts[a],A.verts[a+1],A.verts[a+2]),c.applyMatrix4(p),C[b]=c.x,C[b+1]=c.y,C[b+2]=c.z;g=new THREE.Float32BufferAttribute(C,3);g.name=A.name;w.push(g)}h.morphAttributes.position=w}t.push(h);P.push(l);Q.push(m);O.push(k)}}})();(function(){var d=u.animation;if(d&&d.keyframeAnimations&&0!=d.keyframeAnimations.length){var d=d.keyframeAnimations.concat(),a=[],b,c,e;for(c=0;c<d.length;++c){var h=d[c];if(h){b=h.fps||30;e=!0;var l=h.length||-1;"frames"==h.timeline&&(e=!1,l/=b);for(var m=[],g=h.name||"default",h=h.animNodes||[],f=0;f<h.length;f++){var k=h[f];if(k){var p="";void 0!==k.nodeName?p=k.nodeName:void 0!==k.nodeIndex&&(p=y[k.nodeIndex].name);G(e,b,THREE.VectorKeyframeTrack,p+".position",k.pos,m);G(e,b,THREE.VectorKeyframeTrack,p+".scale",k.scl,m);G(e,b,THREE.QuaternionKeyframeTrack,p+".quaternion",k.rot,m)}}e=0===m.length?null:new THREE.AnimationClip(g,l,m)}else console.error("parseKeyFrameAnimation: no animation"),e=null;e&&a.push(e)}if(0<a.length)for(b=0;b<t.length;++b)if(c=!1,THREE.Geometry&&t[b]instanceof THREE.Geometry?c=t[b].skinIndices&&0<t[b].skinIndices.length&&t[b].skinWeights&&0<t[b].skinWeights.length:t[b]instanceof THREE.BufferGeometry&&(c=t[b].attributes.skinIndex&&0<t[b].attributes.skinIndex.count&&t[b].attributes.skinWeight&&0<t[b].attributes.skinWeight.count),c)t[b].animations=a;else for(t[b].animations=[],c=0;c<d.length;++c)(e=L(d[c],O[b]))&&t[b].animations.push(e)}})();for(E=0;E<t.length;++E)t[E].computeFaceNormals(),t[E].computeBoundingSphere(),w.push({geometry:t[E],type:P[E],jd_object:Q[E]});E=function(){var d=new THREE.Sphere,a,b,c=0,e=0,h=0,l=[],m=[],g=new THREE.Vector3(0,0,0),f=new THREE.Vector3(0,0,0);if(t&&t.length){for(a=0;a<t.length;++a)t[a].boundingSphere||t[a].computeBoundingSphere(),e+=t[a].boundingSphere.radius;if(0<e){for(a=0;a<t.length;++a)b=t[a],m.push(b.boundingSphere.radius),l.push(b.boundingSphere.center),f.copy(b.boundingSphere.center),f.multiplyScalar(b.boundingSphere.radius/e),g.add(f);for(a=0;a<t.length;++a)b=g.distanceTo(l[a]),b>=c&&(c=b,h=c+m[a]);d.center=g;d.radius=h}}return d}();return{nodes:y,objects:w,materials:J,jd_materials:u.materials,boundingSphere:E,createObject:function(d){var a=null;if("Mesh"==w[d].type)a=new THREE.Mesh(w[d].geometry,x(w[d].jd_object)),a.name=w[d].geometry.name,K(a,w[d].jd_object);else if("SkinnedMesh"==w[d].type){a=new THREE.SkinnedMesh(w[d].geometry,x(w[d]));a.name="SkinnedMesh_"+w[d].geometry.name;var b;b=[];var c,e,h,l;for(l=0;l<y.length;l++)h=y[l],c=new THREE.Bone,c.name=h.name,c.position.fromArray(h.pos),c.quaternion.fromArray(h.rotq),c.scale.fromArray(h.scl),b.push(c);for(l=0;l<y.length;l++)h=y[l],-1!==h.parent?b[h.parent].add(b[l]):e=b[l];e&&e.updateMatrixWorld(!0);b=new THREE.Skeleton(b);a.add(b.bones[0]);a.bind(b);K(a,w[d].jd_object)}else"Line"==w[d].type&&(a=w[d].jd_object.color,a=new THREE.Color(a[0]/255,a[1]/255,a[2]/255),a=new THREE.LineBasicMaterial({color:a}),a=new THREE.Line(w[d].geometry,a),a.name=w[d].geometry.name);return a}}}};

export default JDLoader;